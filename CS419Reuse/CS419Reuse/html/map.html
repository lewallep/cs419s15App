<!DOCTYPE HTML />
<html>
<head>
    <title></title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <script type="text/javascript" src="http://ecn.dev.virtualearth.net/mapcontrol/mapcontrol.ashx?v=7.0"></script>
    <script type="text/javascript">
        var map = null;
        function GetMap() {

            map = new Microsoft.Maps.Map(document.getElementById("mapDiv"),
                              {
                                  credentials: "AhTTNOioICXvPRPUdr0_NAYWj64MuGK2msfRendz_fL9B1U6LGDymy2OhbGj7vhA",
                                
                                  mapTypeId: Microsoft.Maps.MapTypeId.road,
                                  zoom: 12
                              });

            // Define the pushpin location
            var loc = new Microsoft.Maps.Location(47.592, -122.332);
            var loc2 = new Microsoft.Maps.Location(46.592, -122.323);

            // Add a pin to the map
            var pin = new Microsoft.Maps.Pushpin(loc);
            map.entities.push(pin);

            var pin2 = new Microsoft.Maps.Pushpin(loc2);
            map.entities.push(pin2);

            // To center the map dynamicaly on our search results I think one way we can do it is to find the   
            // min and max of each latitude and longtitude using a foreach loop of the JSON search results, and then 
            // to use this is a boundary of the map field.  Then baesed on a computed distance I think we could work out 
            // an equation to set the zoom based off a distance as the bird flies.  
            // I "think" this should give us a nice dynamic map which displays the search results.
            var centerLoc = new Microsoft.Maps.Location(((loc.latitude + loc2.latitude)) / 2, -122.323);

            // Center the map on the location
            map.setView({ center: centerLoc, zoom: 8 });
        }

        function ClickGeocode(credentials) {
            map.getCredentials(MakeGeocodeRequest);
        }

        function MakeGeocodeRequest(credentials) {

            var geocodeRequest = "http://dev.virtualearth.net/REST/v1/Locations?query=" + encodeURI(document.getElementById('txtQuery').value) + "&output=json&jsonp=GeocodeCallback&key=" + credentials;

            CallRestService(geocodeRequest);
        }

        function GeocodeCallback(result) {
            

            if (result &&
                   result.resourceSets &&
                   result.resourceSets.length > 0 &&
                   result.resourceSets[0].resources &&
                   result.resourceSets[0].resources.length > 0) {
                // Set the map view using the returned bounding box
                var bbox = result.resourceSets[0].resources[0].bbox;
                var viewBoundaries = Microsoft.Maps.LocationRect.fromLocations(new Microsoft.Maps.Location(bbox[0], bbox[1]), new Microsoft.Maps.Location(bbox[2], bbox[3]));
                map.setView({ bounds: viewBoundaries });

                // Add a pushpin at the found location
                var location = new Microsoft.Maps.Location(result.resourceSets[0].resources[0].point.coordinates[0], result.resourceSets[0].resources[0].point.coordinates[1]);
                var pushpin = new Microsoft.Maps.Pushpin(location);
                map.entities.push(pushpin);
            }
        }

        function CallRestService(request) {
            var script = document.createElement("script");
            script.setAttribute("type", "text/javascript");
            script.setAttribute("src", request);
            document.body.appendChild(script);
        }

    </script>
</head>
<body onload="GetMap();">
    <div id='mapDiv' style="position:relative; width:100%; height:500px;"></div>
    <input id="txtQuery" type="text" value="Portland" />
    <input type="button" value="Geocode" onclick="ClickGeocode()" />    
</body>
</html>
